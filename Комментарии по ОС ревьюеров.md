Кирилл, привет!

От всей команды от души благодарим тебя за такое крутое и в то же время теплое ревью! Нам очень ценна твоя обратная связь и оценка нашего проекта) Спасибо тебе огромное за столь ценные и полезные советы, что ты нам дал, мы очень много узнали классных лайфхаков и фишек по улучшению кода от тебя. Это прям очень круто! Спасибо тебе!)

Мы поправили код практически по всем твоим комментариям и оставили рядом с каждым из них свои. Посмотри, пожалуйста) 

Желаем тебе классных успехов в работе в Яндексе, карьерного и профессионального роста и всего самого лучшего!)



Привет! 

Так как описание проекта происходило от вышей рабочей группы, пишу ОС по проекту сразу для всей команды =)

# По доке

1. Преобразование данных.

- Замена разделителя в числовых данных и изменение типа данных для дат в DDS-слое – это стандартные шаги, но убедитесь, что эти операции выполняются эффективно и без потери информации. На практике достаточно часто вылезаю косяки в этих местах, потом приходится переделывать логику
- При изменении типа данных на stg-слое, удостоверьтесь, что не происходит потеря точности при преобразовании varchar в numeric(14, 2)

2. Обработка данных в DDS-слое.
- Важно правильно фильтровать данные в таблице orders_realizations, чтобы включать только отгруженные товары. Также, убедитесь, что отчеты комиссионеров корректно обрабатываются и добавляются к общей таблице
- При сравнении продаж в monthly_sales_by_sales_channels и "STG".marketplaces, обратите внимание на возможные расхождения и учтите их при выборе актуальных данных

3. Загрузка данных извне.
- Работа с данными от комиссионеров, полученными от менеджеров, требует внимательного контроля за совпадением и актуализацией данных. Удостоверьтесь, что этот процесс документирован и безопасен с точки зрения конфиденциальности

# По коду:

## `from_dds_to_cdm_dag.py`

1. Тут стоит вынести все sql скрипты в отдельные файлы и уже вызывать в даге, иначе получается нагромождение кода

2. Я бы разделил код на функции. Сейчас параметры подключения к базе данных повторяются в каждой функции, что делает код менее читаемым

```py
def connect_to_postgres():
    # код для соединения с PostgreSQL

def truncate_and_insert(table_name, query):
    # код для обрезки таблицы и вставки данных

def execute_query(query):
    # код для выполнения SQL-запроса

def close_connection():
    # код для закрытия соединения

def load_all_months_aggregated_sales():
    # ...

def load_monthly_sales_by_brands():
    # ...

# Аналогичные шаги для остальных функций
```

3. Вместо явного закрытия соединения лучше использовать контекстный менеджер для курсора. Это гарантирует, что соединение будет корректно закрыто даже в случае возникновения исключения.

```py
# Заменить
cur_1 = conn_1.cursor()
# на
with conn_1.cursor() as cur_1:
```

4. Функцию `print` оставляем в детском саду и используем стандартный механизм логирования, предоставляемый библиотекой `logging`

```py
import logging

# Вместо
print("Error with insert at all_months_aggregated_sales:", error)
# Используем
logging.error("Error with insert at all_months_aggregated_sales: %s", error)
```

## `from_stg_to_dds_dag.py`

Тут всё по аналогии с from_dds_to_cdm_dag.py

## `ftp_download.py`

1. Тоже стоит использовать контекстный менеджер

```py
# Замените
ftp = FTP(host)
ftp.login(user=user, passwd=passwd)
# на
with FTP(host) as ftp:
    ftp.login(user=user, passwd=passwd)
```

2. Нет необходимости вызывать `ftp.sendcmd('MDTM ' + file)` для получения времени модификации. Можно использовать `ftp.sendcmd('MDTM ' + latest_name)` прямо внутри условия

```py
modified_time = ftp.sendcmd('MDTM ' + latest_name)
```

3. Проверьте наличие папки перед записью файла, и создайте ее, если она не существует

```py
local_folder_path = os.path.join('/', 'opt', 'airflow', 'plugins', 'files_dir', folder)
if not os.path.exists(local_folder_path):
    os.makedirs(local_folder_path)
```

## `managing_files.py`

1. Замените строку '/opt/files_dir/' на константу или передавайте этот путь как аргумент функции

2. Тут конечно как вам удобнее, но кажется можно обойтись условным выражением

```py
def find_the_latest_local_file_by_name(folder: str) -> str:
    file_list = os.listdir(os.path.join(ROOT_PATH, 'plugins', 'files_dir', folder))
    latest_file = sorted(file_list, reverse=True)
    return '' if not latest_file else os.path.join(ROOT_PATH, str(folder), str(latest_file[0]))
```

## `download_data_files_from_ftp_dag.py`

1. Вместо хранения списка папок в коде, рассмотрите использование Airflow Variable. Это делает код более настраиваемым без необходимости изменения кода DAG. У вас в вебе к сожалению вообще не увидел чтобы применялись Variable

```py
# В Airflow UI можно установить переменную folders_list с списком значений
folders_list = Variable.get("folders_list", default_var=('forecast', 'category', 'sales', 'marketplaces'))
```

## `download_old_sales_file_from_ftp_dag.py`

Тут логика повторяется, сам бог велел попробовать Variable =)

## `upload_data_files_to_stg_dag.py`

1. Добавьте переменные для хранения путей к SQL-скриптам, формата копирования и прочему

```py
SQL_CLEAR_TABLES_PATH = "sql/stg_clearing_tables.sql"
COPY_FORMAT = "format csv, delimiter \";\", header"
```

2. Используйте генераторы списков для более краткого кода

```py
loading_sql_tasks = TaskGroup('load_files_to_stg')

with loading_sql_tasks:
    file_tasks = [
        PostgresOperator(
            task_id=f"stg_loading_table_{folder}",
            postgres_conn_id="postgres_local",
            sql=f"copy \"STG\".{folder} from '{find_the_latest_local_file_by_name(folder)}' with ({COPY_FORMAT});"
        ) for folder in folders
    ]
```
Дорогие студенты,

От всей души поздравляю вас с успешным завершением вашего пет-проекта! Ваш труд, усердие и профессионализм привели к созданию впечатляющего проекта, который, безусловно, выделяется среди прочих

Ваша команда продемонстрировала высокий уровень компетенции, реализовав все необходимые даги, которые успешно запущены и эффективно функционируют. Это свидетельствует не только о вашем глубоком понимании предметной области, но и о навыках в разработке, которые вы успешно применили

Не менее важным достижением является создание корректного и информативного дашборда, который действительно облегчит восприятие данных и сделает их понятными для пользователей. Ваша презентация с легкостью справилась с задачей по объяснению особенностей и преимуществ вашего проекта, демонстрируя ваше умение четко и лаконично представлять информацию

Считаю, что ваш успех является примером для всех студентов, и вы поистине большие молодцы! Надеюсь, что опыт, полученный вами в ходе работы над проектом, будет полезен в вашей будущей карьере, и вы сможете продолжать достигать таких великих результатов

Поздравляю вас еще раз и желаю дальнейших успехов в ваших творческих и профессиональных начинаниях!

С наилучшими пожеланиями, Дикалин Кирилл
